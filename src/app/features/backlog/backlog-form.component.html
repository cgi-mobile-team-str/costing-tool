<div class="form-container">
  <form [formGroup]="form" (ngSubmit)="save()">
    <!-- Hierarchy: Product > Cluster > Feature -->
    <div class="hierarchy-section mb-4">
      <div class="form-group">
        <label>{{ 'backlog.product' | translate }}</label>

        @if (!isProductInputMode()) {
          <div class="input-group">
            <select
              formControlName="productId"
              (change)="onProductSelect($event)"
              class="form-control"
            >
              <option value="" disabled selected>
                {{ 'backlog.select_placeholder' | translate }}
              </option>
              @for (p of allProducts(); track p.id) {
                <option [value]="p.id">{{ p.name }}</option>
              }
              <option value="__NEW__">{{ 'backlog.new_product_option' | translate }}</option>
            </select>
          </div>
        } @else {
          <div class="input-group d-flex gap-2">
            <input
              type="text"
              [ngModel]="newProductName()"
              (ngModelChange)="newProductName.set($event)"
              [ngModelOptions]="{ standalone: true }"
              class="form-control"
              [placeholder]="'backlog.new_product_placeholder' | translate"
            />
            <button z-button size="sm" type="button" (click)="saveNewProduct()">
              {{ 'common.ok' | translate }}
            </button>
            <button z-button size="sm" zType="secondary" type="button" (click)="cancelNewProduct()">
              {{ 'common.cancel' | translate }}
            </button>
          </div>
        }
      </div>

      <div class="form-group mt-3">
        <label>{{ 'backlog.cluster' | translate }}</label>

        @if (currentProductId()) {
          @if (!isClusterInputMode()) {
            <div class="input-group">
              <select
                formControlName="clusterId"
                (change)="onClusterSelect($event)"
                class="form-control"
              >
                <option value="" disabled selected>
                  {{ 'backlog.select_placeholder' | translate }}
                </option>
                @for (c of availableClusters(); track c.id) {
                  <option [value]="c.id">{{ c.name }}</option>
                }
                <option value="__NEW__">{{ 'backlog.new_cluster_option' | translate }}</option>
              </select>
            </div>
          } @else {
            <div class="input-group d-flex gap-2">
              <input
                type="text"
                [ngModel]="newClusterName()"
                (ngModelChange)="newClusterName.set($event)"
                [ngModelOptions]="{ standalone: true }"
                class="form-control"
                [placeholder]="'backlog.new_cluster_placeholder' | translate"
              />
              <button z-button size="sm" type="button" (click)="saveNewCluster()">
                {{ 'common.ok' | translate }}
              </button>
              <button
                z-button
                size="sm"
                zType="secondary"
                type="button"
                (click)="cancelNewCluster()"
              >
                {{ 'common.cancel' | translate }}
              </button>
            </div>
          }
        } @else {
          <div class="text-sm text-gray-500 italic mt-2">
            {{ 'backlog.select_product_first_hint' | translate }}
          </div>
        }
      </div>
    </div>

    <div class="form-group">
      <label>{{ 'backlog.title' | translate }}</label>
      <input
        type="text"
        formControlName="title"
        class="form-control"
        [placeholder]="'backlog.title_placeholder' | translate"
        #titleInput
      />
    </div>

    <!-- Description -->
    <div class="form-group">
      <label>{{ 'backlog.description' | translate }}</label>
      <textarea formControlName="description" class="form-control" rows="2"></textarea>
    </div>

    <!-- Hypotheses & Comments -->
    <div class="row">
      <div class="form-group col">
        <label>{{ 'backlog.hypotheses' | translate }}</label>
        <textarea formControlName="hypotheses" class="form-control" rows="2"></textarea>
      </div>
      <div class="form-group col">
        <label>{{ 'backlog.comments' | translate }}</label>
        <textarea formControlName="comments" class="form-control" rows="2"></textarea>
      </div>
    </div>

    <!-- Scope & MoSCoW -->
    <div class="row">
      <div class="form-group col">
        <label>{{ 'backlog.scope' | translate }}</label>
        <select formControlName="scope" class="form-control">
          <option value="MVP">{{ 'backlog.scope_mvp' | translate }}</option>
          <option value="V1">{{ 'backlog.scope_v1' | translate }}</option>
          <option value="V2">{{ 'backlog.scope_v2' | translate }}</option>
        </select>
      </div>
      <div class="form-group col">
        <label>{{ 'backlog.moscow' | translate }}</label>
        <select formControlName="moscow" class="form-control">
          <option value="MUST">{{ 'backlog.moscow_must' | translate }}</option>
          <option value="SHOULD">{{ 'backlog.moscow_should' | translate }}</option>
          <option value="COULD">{{ 'backlog.moscow_could' | translate }}</option>
          <option value="WONT">{{ 'backlog.moscow_wont' | translate }}</option>
        </select>
      </div>
    </div>

    <!-- Profile, Type, Effort -->
    <div class="row">
      <div class="form-group col">
        <label>{{ 'backlog.profile' | translate }}</label>
        <select formControlName="profileId" class="form-control">
          @for (p of profiles(); track p.id) {
            <option [value]="p.id">
              {{ p.name }} ({{ p.dailyRate }}{{ 'common.currency_per_day' | translate }})
            </option>
          }
        </select>
      </div>
      <div class="form-group col">
        <label>{{ 'backlog.chargeType' | translate }}</label>
        <select formControlName="chargeType" class="form-control">
          <option value="days">{{ 'backlog.rtu' | translate }}</option>
          <option value="ratio">
            {{ 'backlog.ratio' | translate }} {{ 'backlog.percent' | translate }}
          </option>
        </select>
      </div>
      <div class="form-group col">
        <label>{{ 'backlog.effort' | translate }}</label>
        <input type="number" formControlName="effortDays" class="form-control" step="0.1" />
      </div>
    </div>

    <div class="cost-preview">
      <strong>{{ 'backlog.cost' | translate }} {{ 'backlog.cost_ht' | translate }}:</strong>
      {{ calculatedCost() | currency: 'EUR' }}
    </div>

    @if (!isSheetMode) {
      <div class="actions">
        <button z-button zType="secondary" type="button" routerLink="/backlog">
          {{ 'common.cancel' | translate }}
        </button>
        <button z-button type="submit" [zDisabled]="form.invalid">
          {{ 'common.save' | translate }}
        </button>
      </div>
    }
  </form>
</div>
