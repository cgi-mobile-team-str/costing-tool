<div class="backlog-container">
  <div class="header">
    <div>
      <span class="context-label">{{ 'nav.backlog' | translate }}</span>
      <h2>{{ settings().projectName }}</h2>
    </div>
    <button z-button (click)="openBacklogSheet()">
      <z-icon zType="plus" />
      {{ 'common.add' | translate }}
    </button>
  </div>

  <app-backlog-filters
    [profiles]="profiles"
    [searchTerm]="searchTerm()"
    [scopeFilter]="scopeFilter()"
    [profileFilter]="profileFilter()"
    (searchTermChange)="searchTerm.set($event)"
    (scopeFilterChange)="scopeFilter.set($event)"
    (profileFilterChange)="profileFilter.set($event)"
  />

  <app-column-selector
    [availableColumns]="availableColumns"
    [visibleColumns]="visibleColumns()"
    (visibleColumnsChange)="visibleColumns.set($event)"
  />

  @for (prodGroup of groupedItems(); track prodGroup.product) {
    <app-backlog-product-section
      [productGroup]="prodGroup"
      [profiles]="profiles"
      [isExpanded]="isProductExpanded(prodGroup.product)"
      [selectedIds]="selectedIds()"
      [editingCell]="editingCell()"
      [productTotal]="getProductTotal(prodGroup)"
      [productEffort]="getProductEffort(prodGroup)"
      [visibleColumns]="visibleColumns()"
      [getItemCost]="getItemCost.bind(this)"
      (toggleExpand)="toggleProduct($event)"
      (toggleAll)="toggleAllProduct($event, prodGroup)"
      (selectionToggle)="toggleSelection($event)"
      (editStart)="startEdit($event.itemId, $event.field)"
      (editSave)="saveEdit($event)"
      (editCancel)="cancelEdit()"
      (duplicateItem)="duplicate($event)"
      (deleteItem)="delete($event)"
      (addItem)="openAddItemWithDefaults($event)"
      (moveItemUp)="onMoveItemUp($event)"
      (moveItemDown)="onMoveItemDown($event)"
    />
  }
  @if (groupedItems().length === 0) {
    <div class="empty-state">
      <p>{{ 'backlog.no_items' | translate }}</p>
    </div>
  }

  <app-bulk-actions-toast
    [count]="selectedIds().length"
    [visible]="selectedIds().length > 0"
    [message]="i18n.translate('common.selected')"
    [deleteLabel]="i18n.translate('common.delete_selected')"
    (close)="selectedIds.set([])"
    (delete)="deleteSelected()"
  />
</div>
