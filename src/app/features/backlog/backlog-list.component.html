<div class="backlog-container">
  <div class="title-header">
    <div>
      <span class="title-context-label">{{ 'nav.backlog' | translate }}</span>
      <h2>{{ currentProjectName() }}</h2>
    </div>
    <div class="flex gap-2 items-center">
      <!-- Version Controls -->
      <div class="flex items-center gap-2 mr-4 border-r pr-4 border-gray-200">
        <z-select
          class="min-w-[200px]"
          [(value)]="activeVersion"
          [zPlaceholder]="'backlog.draft' | translate"
        >
          <z-select-item [zValue]="null">
            {{ 'backlog.draft' | translate }}
          </z-select-item>
          @for (v of versions(); track v.id) {
            <z-select-item [zValue]="v.id">
              {{ v.name }} ({{ v.createdAt | date: 'shortDate' }})
            </z-select-item>
          }
        </z-select>

        @if (!activeVersion()) {
          <z-button
            zType="outline"
            (click)="createVersion()"
            [title]="'backlog.create_version_snapshot' | translate"
          >
            <z-icon zType="camera" />
          </z-button>
        }
      </div>

      <z-button
        zType="outline"
        (click)="toggleAllExpand()"
        [title]="allClustersExpanded() ? 'Tout replier' : 'Tout déplier'"
      >
        <z-icon [zType]="allClustersExpanded() ? 'chevron-up' : 'chevron-down'" />
        {{ allClustersExpanded() ? 'Tout replier' : 'Tout déplier' }}
      </z-button>
      <z-button zType="outline" (click)="openManagementSheet()" [zDisabled]="isReadOnly()">
        <z-icon zType="settings" />
      </z-button>
      <button z-button (click)="openBacklogSheet()" [disabled]="isReadOnly()">
        <z-icon zType="plus" />
        {{ 'common.add' | translate }}
      </button>
    </div>
  </div>

  <app-backlog-filters
    [profiles]="profiles()"
    [searchTerm]="searchTerm()"
    [scopeFilter]="scopeFilter()"
    [profileFilter]="profileFilter()"
    [historyFilter]="historyFilter()"
    [isReadOnly]="isReadOnly()"
    (searchTermChange)="searchTerm.set($event)"
    (scopeFilterChange)="scopeFilter.set($event)"
    (profileFilterChange)="profileFilter.set($event)"
    (historyFilterChange)="historyFilter.set($event)"
  />

  <app-column-selector
    [availableColumns]="availableColumns"
    [visibleColumns]="visibleColumns()"
    (visibleColumnsChange)="visibleColumns.set($event)"
  />

  @for (prodGroup of groupedItems(); track prodGroup.product) {
    <app-backlog-product-section
      [productGroup]="prodGroup"
      [profiles]="profiles()"
      [isExpanded]="isProductExpanded(prodGroup.product)"
      [isReadOnly]="isReadOnly()"
      [selectedIds]="selectedIds()"
      [editingCell]="editingCell()"
      [productTotal]="getProductTotal(prodGroup)"
      [productEffort]="getProductEffort(prodGroup)"
      [visibleColumns]="visibleColumns()"
      [getItemCost]="getItemCost.bind(this)"
      [getItemEffort]="getItemEffort.bind(this)"
      [forceExpandClusters]="allClustersExpanded()"
      (toggleExpand)="toggleProduct($event)"
      (toggleAll)="toggleAllProduct($event, prodGroup)"
      (selectionToggle)="toggleSelection($event)"
      (editStart)="startEdit($event.itemId, $event.field)"
      (editSave)="saveEdit($event)"
      (editCancel)="cancelEdit()"
      (duplicateItem)="duplicate($event)"
      (deleteItem)="delete($event)"
      (addItem)="openAddItemWithDefaults($event)"
      (moveItemUp)="onMoveItemUp($event)"
      (moveItemDown)="onMoveItemDown($event)"
      (moveProductUp)="onMoveProductUp($any($event))"
      (moveProductDown)="onMoveProductDown($any($event))"
      (moveClusterUp)="onMoveClusterUp($any($event))"
      (moveClusterDown)="onMoveClusterDown($any($event))"
      (renameProduct)="onRenameProduct($event)"
      (renameCluster)="onRenameCluster($event)"
      (toggleAllCluster)="toggleAllCluster($event.checked, $event.clusterGroup)"
      (viewHistory)="openHistoryDialog($event)"
    />
  }
  @if (groupedItems().length === 0) {
    <div class="empty-state">
      <p>{{ 'backlog.no_items' | translate }}</p>
    </div>
  }

  <app-bulk-actions-toast
    [count]="selectedIds().length"
    [visible]="selectedIds().length > 0"
    [message]="i18n.translate('common.selected')"
    [deleteLabel]="i18n.translate('common.delete_selected')"
    (close)="selectedIds.set([])"
    (delete)="deleteSelected()"
    (edit)="editSelected()"
  />
</div>

<ng-template #createVersionDialog>
  <div class="py-2">
    <p class="text-sm text-slate-500 mb-4">{{ 'backlog.enter_version_name' | translate }}</p>
    <div class="flex flex-col gap-1.5">
      <input z-input type="text" [(ngModel)]="newVersionName" placeholder="v1.0" autofocus />
    </div>
  </div>
</ng-template>
