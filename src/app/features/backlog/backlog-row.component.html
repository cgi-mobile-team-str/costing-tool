<tr>
  <td class="select-col">
    <div
      style="display: flex; justify-content: center; align-items: center; width: 100%; height: 100%"
    >
      <z-checkbox
        *ngIf="!isReadOnly"
        [checked]="isSelected"
        (checkChange)="selectionToggle.emit(item.id)"
      />
    </div>
  </td>
  <!-- Title -->
  <td class="title-col" (dblclick)="!isReadOnly && startEdit('title')">
    @if (isEditing('title')) {
      <input
        type="text"
        class="inline-edit"
        [(ngModel)]="item.title"
        (blur)="saveEdit()"
        (keydown.enter)="saveEdit()"
        (keydown.escape)="cancelEdit()"
      />
    } @else {
      <div class="flex items-center gap-2">
        <strong class="item-title-text" [title]="item.title">{{ item.title }}</strong>
        <!-- Modification Indicator (Left) -->
        @if (item.updatedAt && !isReadOnly) {
          <button
            type="button"
            class="indicator-box indicator-modified"
            [title]="'history.action_update' | translate"
            [appHistoryTooltip]="item.id"
            [appHistoryTooltipDisabled]="!item.updatedAt"
            [creatorName]="item.creatorName || ''"
            [createdAt]="item.createdAt || ''"
            (click)="$event.stopPropagation(); viewHistory.emit(item)"
          >
            <span class="modified-dot"></span>
          </button>
        }

        <!-- Comment Indicator (Right) -->
        <button
          type="button"
          class="indicator-box"
          [class.active]="hasComments"
          (click)="onViewComments($event)"
          [title]="'backlog.view_comments' | translate"
          [appCommentsTooltip]="item.id"
          [appCommentsTooltipDisabled]="!hasComments"
        >
          <z-icon zType="message-square" class="w-3.5 h-3.5" />
          @if (hasComments) {
            <span
              class="absolute -top-1 -right-1 bg-blue-600 text-white text-[8px] font-bold min-w-[14px] h-[14px] rounded-full flex items-center justify-center px-0.5 shadow-sm"
            >
              {{ item.commentCount }}
            </span>
          }
        </button>
      </div>
    }
  </td>
  <!-- Description -->
  @if (visibleColumns.includes('description')) {
    <td class="desc-col text-small" (dblclick)="!isReadOnly && startEdit('description')">
      @if (isEditing('description')) {
        <textarea
          class="inline-edit"
          [(ngModel)]="item.description"
          (blur)="saveEdit()"
          (keydown.escape)="cancelEdit()"
          rows="2"
        ></textarea>
      } @else {
        {{ item.description || '-' }}
      }
    </td>
  }
  <!-- Hypotheses -->
  @if (visibleColumns.includes('hypotheses')) {
    <td class="hyp-col text-small" (dblclick)="!isReadOnly && startEdit('hypotheses')">
      @if (isEditing('hypotheses')) {
        <textarea
          class="inline-edit"
          [(ngModel)]="item.hypotheses"
          (blur)="saveEdit()"
          (keydown.escape)="cancelEdit()"
          rows="2"
        ></textarea>
      } @else {
        {{ item.hypotheses || '-' }}
      }
    </td>
  }
  <!-- Comments -->
  @if (visibleColumns.includes('comments')) {
    <td class="comm-col text-small" (dblclick)="!isReadOnly && startEdit('comments')">
      @if (isEditing('comments')) {
        <textarea
          class="inline-edit"
          [(ngModel)]="item.comments"
          (blur)="saveEdit()"
          (keydown.escape)="cancelEdit()"
          rows="2"
        ></textarea>
      } @else {
        {{ item.comments || '-' }}
      }
    </td>
  }
  <!-- Moscow -->
  @if (visibleColumns.includes('moscow')) {
    <td class="moscow-col text-center" (dblclick)="!isReadOnly && startEdit('moscow')">
      @if (isEditing('moscow')) {
        <select
          class="inline-edit-select"
          [(ngModel)]="item.moscow"
          (blur)="cancelEdit()"
          (change)="saveEdit()"
        >
          <option value="MUST">{{ 'backlog.moscow_must' | translate }}</option>
          <option value="SHOULD">{{ 'backlog.moscow_should' | translate }}</option>
          <option value="COULD">{{ 'backlog.moscow_could' | translate }}</option>
          <option value="WONT">{{ 'backlog.moscow_wont' | translate }}</option>
        </select>
      } @else {
        <span class="badge moscow" [class]="'moscow-' + item.moscow">{{
          (getMoscowLabel(item.moscow) | translate) || '-'
        }}</span>
      }
    </td>
  }
  <!-- Scope -->
  @if (visibleColumns.includes('scope')) {
    <td class="scope-col text-center" (dblclick)="!isReadOnly && startEdit('scope')">
      @if (isEditing('scope')) {
        <select
          class="inline-edit-select"
          [(ngModel)]="item.scope"
          (blur)="cancelEdit()"
          (change)="saveEdit()"
        >
          <option value="MVP">{{ 'backlog.scope_mvp' | translate }}</option>
          <option value="V1">{{ 'backlog.scope_v1' | translate }}</option>
          <option value="V2">{{ 'backlog.scope_v2' | translate }}</option>
        </select>
      } @else {
        <span class="badge" [class]="item.scope">{{ getScopeLabel(item.scope) | translate }}</span>
      }
    </td>
  }
  <!-- Profile -->
  @if (visibleColumns.includes('profile')) {
    <td class="profile-col text-center" (dblclick)="!isReadOnly && startEdit('profileId')">
      @if (isEditing('profileId')) {
        <select
          class="inline-edit-select"
          [(ngModel)]="item.profileId"
          (blur)="cancelEdit()"
          (change)="saveEdit()"
        >
          @for (p of profiles; track p.id) {
            <option [value]="p.id">{{ p.name }}</option>
          }
        </select>
      } @else {
        {{ getProfileName(item.profileId) }}
      }
    </td>
  }
  <!-- Charge Type -->
  @if (visibleColumns.includes('chargeType')) {
    <td class="type-col" (dblclick)="!isReadOnly && startEdit('chargeType')">
      @if (isEditing('chargeType')) {
        <select
          class="inline-edit-select"
          [(ngModel)]="item.chargeType"
          (blur)="cancelEdit()"
          (change)="saveEdit()"
        >
          <option value="days">{{ 'backlog.rtu' | translate }}</option>
          <option value="ratio">{{ 'backlog.ratio' | translate }}</option>
        </select>
      } @else {
        {{ (item.chargeType === 'ratio' ? 'backlog.ratio' : 'backlog.rtu') | translate }}
      }
    </td>
  }
  <!-- Effort -->
  @if (visibleColumns.includes('effort')) {
    <td
      class="effort-col effort-cell text-center"
      (dblclick)="!isReadOnly && startEdit('effortDays')"
    >
      @if (isEditing('effortDays')) {
        <input
          type="number"
          class="inline-edit"
          [(ngModel)]="item.effortDays"
          (blur)="saveEdit()"
          (keydown.enter)="saveEdit()"
          (keydown.escape)="cancelEdit()"
          step="0.001"
          min="0"
        />
      } @else {
        <div class="effort-value-container">
          <span class="effort-main-value">
            {{ item.effortDays | number: '1.1-3' }}{{ item.chargeType === 'ratio' ? '%' : ' j/h' }}
          </span>
          @if (item.chargeType === 'ratio') {
            <span class="effort-secondary-value">({{ itemEffort | number: '1.1-3' }} j)</span>
          }
        </div>
      }
    </td>
  }
  @if (visibleColumns.includes('cost')) {
    <td class="cost-col text-center">{{ itemCost | currency: 'EUR' }}</td>
  }
  <td class="actions actions-col">
    <div class="actions-container">
      <button
        type="button"
        z-button
        zType="outline"
        zSize="xs"
        z-dropdown
        [zDropdownMenu]="actionMenu"
        zAlign="end"
      >
        <img src="assets/ellipsis-vertical-solid-full.svg" alt="Edit" width="16" height="16" />
      </button>

      <z-dropdown-menu-content #actionMenu="zDropdownMenuContent">
        @if (!isReadOnly) {
          <z-dropdown-menu-item (click)="startEdit('title')">
            <z-icon zType="pencil" class="mr-2 h-4 w-4" />
            {{ 'common.edit' | translate }}
          </z-dropdown-menu-item>
          <z-dropdown-menu-item (click)="duplicateItem.emit(item)">
            <z-icon zType="copy" class="mr-2 h-4 w-4" />
            {{ 'common.duplicate' | translate }}
          </z-dropdown-menu-item>
          @if (!isFirst) {
            <z-dropdown-menu-item (click)="moveItemUp.emit(item)">
              <z-icon zType="arrow-up" class="mr-2 h-4 w-4" />
              {{ 'common.move_up' | translate }}
            </z-dropdown-menu-item>
          }

          @if (!isLast) {
            <z-dropdown-menu-item (click)="moveItemDown.emit(item)">
              <z-icon zType="arrow-down" class="mr-2 h-4 w-4" />
              {{ 'common.move_down' | translate }}
            </z-dropdown-menu-item>
          }
        }
        @if (!isReadOnly) {
          <z-dropdown-menu-item (click)="viewHistory.emit(item)">
            <z-icon zType="clock" class="mr-2 h-4 w-4" />
            {{ 'common.history' | translate }}
          </z-dropdown-menu-item>
        }
        @if (!isReadOnly) {
          <z-dropdown-menu-item (click)="deleteItem.emit(item)">
            <z-icon zType="trash" class="mr-2 h-4 w-4 text-destructive" />
            <span class="text-destructive">{{ 'common.delete' | translate }}</span>
          </z-dropdown-menu-item>
        }
      </z-dropdown-menu-content>
    </div>
  </td>
</tr>
