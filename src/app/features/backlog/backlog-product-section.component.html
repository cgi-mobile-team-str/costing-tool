<div class="product-section">
  <h3 class="product-title">
    <div class="product-title-content" (click)="toggleExpand.emit(productGroup.product)">
      <span class="chevron" [class.expanded]="isExpanded">▶</span>
      <span class="product-name">{{ productGroup.product }}</span>
      <z-button
        *ngIf="!isReadOnly"
        class="edit-btn"
        zType="ghost"
        zSize="xs"
        (click)="$event.stopPropagation(); openRenameDialog()"
        title="{{ 'common.edit' | translate }}"
      >
        <img
          src="assets/pen-to-square-regular-full.svg"
          alt="Edit"
          class="h-5 w-5 invert brightness-0 filter"
        />
      </z-button>
      <z-button
        *ngIf="!isReadOnly"
        class="move-btn"
        zType="ghost"
        zSize="xs"
        (click)="$event.stopPropagation(); moveProductUp.emit(productGroup.productId)"
        title="{{ 'common.move_up' | translate }}"
      >
        <img
          src="assets/circle-up-regular-full.svg"
          alt="Move Up"
          class="h-4 w-4 invert brightness-0 filter"
        />
      </z-button>
      <z-button
        *ngIf="!isReadOnly"
        class="move-btn"
        zType="ghost"
        zSize="xs"
        (click)="$event.stopPropagation(); moveProductDown.emit(productGroup.productId)"
        title="{{ 'common.move_down' | translate }}"
      >
        <img
          src="assets/circle-down-regular-full.svg"
          alt="Move Down"
          class="h-4 w-4 invert brightness-0 filter"
        />
      </z-button>
    </div>
    <div class="product-stats" (click)="toggleExpand.emit(productGroup.product)">
      <span class="product-effort">{{ productEffort | number: '1.1-3' }} j/h</span>
      <span class="product-cost">{{ productTotal | currency: 'EUR' }}</span>
    </div>
  </h3>
  @if (isExpanded) {
    @for (cluster of productGroup.clusters; track cluster.clusterId) {
      <div class="cluster-section">
        <!-- Detached Cluster Title Line -->
        <h4 class="cluster-title" (click)="toggleCluster(cluster.clusterId)">
          <div class="cluster-title-content">
            <span class="chevron" [class.expanded]="isClusterExpanded(cluster.clusterId)">▶</span>
            <span class="cluster-name">{{ cluster.cluster }}</span>

            <div class="cluster-actions">
              <z-button
                *ngIf="!isReadOnly"
                class="edit-btn"
                zType="ghost"
                zSize="xs"
                (click)="
                  $event.stopPropagation();
                  openRenameClusterDialog(cluster.cluster, cluster.clusterId)
                "
                title="{{ 'common.edit' | translate }}"
              >
                <img
                  src="assets/pen-to-square-regular-full.svg"
                  alt="Edit"
                  class="h-4 w-4 invert"
                />
              </z-button>

              <z-button
                *ngIf="!isReadOnly"
                class="move-btn"
                zType="ghost"
                zSize="xs"
                (click)="$event.stopPropagation(); moveClusterUp.emit(cluster.clusterId)"
                title="{{ 'common.move_up' | translate }}"
              >
                <img src="assets/circle-up-regular-full.svg" alt="Move Up" class="h-4 w-4 invert" />
              </z-button>

              <z-button
                *ngIf="!isReadOnly"
                class="move-btn"
                zType="ghost"
                zSize="xs"
                (click)="$event.stopPropagation(); moveClusterDown.emit(cluster.clusterId)"
                title="{{ 'common.move_down' | translate }}"
              >
                <img
                  src="assets/circle-down-regular-full.svg"
                  alt="Move Down"
                  class="h-4 w-4 invert"
                />
              </z-button>

              <z-button
                *ngIf="!isReadOnly"
                class="add-item-btn-inline"
                zType="ghost"
                zSize="xs"
                (click)="
                  $event.stopPropagation();
                  addItem.emit({ productId: productGroup.productId, clusterId: cluster.clusterId })
                "
                title="{{ 'common.add' | translate }}"
              >
                <z-icon zType="plus" class="h-4 w-4" />
              </z-button>
            </div>
          </div>

          <div class="cluster-stats">
            <span class="cluster-effort"
              >{{ getClusterEffort(cluster.items) | number: '1.1-3' }} j/h</span
            >
            <span class="cluster-cost">{{ getClusterTotal(cluster.items) | currency: 'EUR' }}</span>
          </div>
        </h4>

        <!-- Integrated Table (Header + Items) -->
        @if (isClusterExpanded(cluster.clusterId)) {
          <app-backlog-table
            [clusterGroup]="cluster"
            [profiles]="profiles"
            [selectedIds]="selectedIds"
            [editingCell]="editingCell"
            [visibleColumns]="visibleColumns"
            [getItemCost]="getItemCost"
            [getItemEffort]="getItemEffort"
            [showHeader]="true"
            [isReadOnly]="isReadOnly"
            (toggleAll)="toggleAllCluster.emit({ checked: $event, clusterGroup: cluster })"
            (selectionToggle)="selectionToggle.emit($event)"
            (editStart)="editStart.emit($event)"
            (editSave)="editSave.emit($event)"
            (editCancel)="editCancel.emit()"
            (duplicateItem)="duplicateItem.emit($event)"
            (deleteItem)="deleteItem.emit($event)"
            (moveItemUp)="moveItemUp.emit($event)"
            (moveItemDown)="moveItemDown.emit($event)"
            (viewHistory)="viewHistory.emit($event)"
          />
        }
      </div>
    }
  }
</div>
